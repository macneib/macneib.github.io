{"componentChunkName":"component---src-templates-blog-post-js","path":"/02-microk8s-multus-raspberry-pi/","result":{"data":{"site":{"siteMetadata":{"title":"Blair MacNeil's Blog"}},"markdownRemark":{"id":"97fd4cf9-633a-504b-9c7f-bb4d93b194fb","excerpt":"Introduction This ultimately failed because multus for microk8s was disabled for ARM64 targets.\nI will watch this issue and try again this PR has been acceptedâ€¦","html":"<h3>Introduction</h3>\n<p>This ultimately failed because multus for microk8s was disabled for ARM64 targets.\nI will watch <a href=\"https://github.com/ubuntu/microk8s/pull/1872\">this issue</a> and try again this PR has been accepted.</p>\n<p>Will try with k3sup as that has flannel-cni installed by default and people recomend that as a good starting place.</p>\n<h3>Step by step instructions</h3>\n<p>change the password in each pi board</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ssh ubuntu@192.168.1.16\nexit\n\nssh ubuntu@192.168.1.17\nexit\n\nssh ubuntu@192.168.1.18\nexit\n\nssh ubuntu@192.168.1.19\nexit</code></pre></div>\n<p>Add nodes in dev machines <code class=\"language-text\">/etc/hosts</code> files</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo vim /etc/hosts</code></pre></div>\n<p>Paste the following snippet</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">192.168.1.16    master01 master01.microk8s\n192.168.1.17    worker01 worker01.microk8s\n192.168.1.18    worker02 worker02.microk8s\n192.168.1.19    worker03 worker03.microk8s</code></pre></div>\n<p>install ansible on control machine</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">apt install ansible</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo vim /etc/ansible/hosts</code></pre></div>\n<p>Paste the following snippet</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[masters]\nmaster01  ansible_connection=ssh   var_hostname=master01 ansible_ssh_private_key_file=/home/macneib/.ssh/id_ed25519 ansible_ssh_user=ubuntu\n#master02  ansible_connection=ssh   var_hostname=master02\n#master03  ansible_connection=ssh   var_hostname=master03\n\n[workers]\nworker01  ansible_connection=ssh  var_hostname=worker01 ansible_ssh_private_key_file=/home/macneib/.ssh/id_ed25519 ansible_ssh_user=ubuntu\nworker02  ansible_connection=ssh  var_hostname=worker02 ansible_ssh_private_key_file=/home/macneib/.ssh/id_ed25519 ansible_ssh_user=ubuntu\nworker03  ansible_connection=ssh  var_hostname=worker03 ansible_ssh_private_key_file=/home/macneib/.ssh/id_ed25519 ansible_ssh_user=ubuntu\n#worker04  ansible_connection=ssh  var_hostname=worker04\n#worker05  ansible_connection=ssh  var_hostname=worker05\n#worker06  ansible_connection=ssh  var_hostname=worker06\n\n[microk8s:children]\nmasters\nworkers</code></pre></div>\n<p>Generate an ssh key</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ssh-keygen -t ed25519 -C &quot;your_email@example.com&quot;</code></pre></div>\n<p>Copy ssh key over to remote machines</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ssh-copy-id -i ~/.ssh/id_ed25519.pub ubuntu@192.168.1.16\nssh-copy-id -i ~/.ssh/id_ed25519.pub ubuntu@192.168.1.17\nssh-copy-id -i ~/.ssh/id_ed25519.pub ubuntu@192.168.1.18\nssh-copy-id -i ~/.ssh/id_ed25519.pub ubuntu@192.168.1.19</code></pre></div>\n<p>Check if Ansible is working fine and can connect to all nodes</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ansible microk8s -m ping</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ansible microk8s -b -m shell -a &quot;hostnamectl set-hostname {{ var_hostname }}&quot;\nansible microk8s -b -m shell -a &quot;hostnamectl status | grep hostname&quot;</code></pre></div>\n<p>Update the OS</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ansible microk8s -m apt -a &quot;upgrade=yes update_cache=yes&quot; --become</code></pre></div>\n<p>Enable c-groups so the kubelet will work out of the box</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ansible microk8s -b -m shell -a &quot;sed -i &#39;$ s/$/ cgroup_enable=cpuset cgroup_enable=memory cgroup_memory=1 swapaccount=1/&#39; /boot/firmware/cmdline.txt&quot;</code></pre></div>\n<p>Quick restart to get all the machines updated</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ansible microk8s -b -m shell -a &quot;shutdown -r now&quot;</code></pre></div>\n<p>Install the MicroK8s snap and components</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ansible microk8s -b -m shell -a &quot;sudo snap install microk8s --classic&quot;\nansible microk8s -b -m shell -a &quot;sudo microk8s.enable dns storage&quot;\nsudo reboot now</code></pre></div>\n<p>Wait 1 minute then check status of masters</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ansible masters -b -m shell -a &quot;sudo microk8s.kubectl get nodes&quot;</code></pre></div>\n<p>Add workers to master</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ansible masters -b -m shell -a &quot;sudo microk8s.add-node&quot;\nansible worker01 -b -m shell -a &quot;microk8s join 192.168.1.16:25000/&lt;token&gt;&quot;\n\nansible masters -b -m shell -a &quot;sudo microk8s.add-node&quot;\nansible worker02 -b -m shell -a &quot;microk8s join 192.168.1.16:25000/&lt;token&gt;&quot;\n\nansible masters -b -m shell -a &quot;sudo microk8s.add-node&quot;\nansible worker03 -b -m shell -a &quot;microk8s join 192.168.1.16:25000/&lt;token&gt;&quot;</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ansible masters -b -m shell -a &quot;sudo microk8s enable multus&quot;</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[WARNING]: Consider using &#39;become&#39;, &#39;become_method&#39;, and &#39;become_user&#39; rather than running sudo\nmaster01 | FAILED | rc=1 &gt;&gt;\nNothing to do for `multus`.non-zero return code</code></pre></div>\n<p>And this is the point where I realized that multus is not enabled on microk8s</p>","frontmatter":{"title":"Microk8s with Calico and Multus on a Raspberry pi cluster","date":"February 24, 2021","description":"Notes from setting up microk8s with calico and multus on a raspberry pi cluster"}},"previous":{"fields":{"slug":"/01-pulsar-and-ros2/"},"frontmatter":{"title":"Apache Pulsar and ROS2"}},"next":{"fields":{"slug":"/03-k3sup-flannel-multus-raspberry-pi/"},"frontmatter":{"title":"k3sup with Flannel and Multus on a Raspberry pi cluster"}}},"pageContext":{"id":"97fd4cf9-633a-504b-9c7f-bb4d93b194fb","previousPostId":"4f1b6900-0567-538a-a5fb-f7456e38cb00","nextPostId":"71463ff8-6e36-5a3f-9a6d-028dcee2e444"}},"staticQueryHashes":["2841359383","916993862"]}